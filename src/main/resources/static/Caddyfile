{
	order jwtauth before reverse_proxy
	debug
}

# Listen on all interfaces on port 8080 so it works with the host's public IP.
# We intentionally serve plain HTTP here so that accessing http://PUBLIC_IP:8080
# does not require a hostname-based TLS certificate.
:8080 {
	encode gzip
	# If you later have a proper domain and want HTTPS, you can enable TLS like:
	# tls internal

	route /ws {
		jwtauth {
			sign_key {$CADDY_JWTAUTH_SIGN_KEY}
			sign_alg HS256
			user_claims name
			from_query token
		}

		reverse_proxy jettybackend:8090 {
			header_up X-User {http.auth.user.id}
			# header_up Sec-WebSocket-Key {http.request.uuid}
			header_up Upgrade websocket
			header_up Connection Upgrade
		}
	}

	@css path /css/*
	handle @css {
		root * ./web
		file_server
		header {
			Cache-Control "public, max-age=31536000"
		}
	}

	@js path /js/*
	handle @js {
		root * ./web
		file_server
		header {
			Cache-Control "public, max-age=31536000"
		}
	}

	route / {
		file_server {
			root ./web
			index index.html
		}

		header / {
			Cache-Control "public, max-age=31536000" # Cache for 1 year
		}
	}

	route /* {
		reverse_proxy jettybackend:8090
	}
}
